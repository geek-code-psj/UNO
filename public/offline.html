<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description"
        content="Play UNO offline against AI bots ‚Äî no internet needed! Full game with official rules.">
    <title>UNO Arena ‚Äî Offline Play</title>
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        .offline-setup {
            max-width: 500px;
            margin: 40px auto;
            text-align: center;
        }

        .offline-setup h1 {
            font-size: 2.2rem;
            margin-bottom: 8px;
        }

        .offline-setup .subtitle {
            color: var(--text-secondary);
            margin-bottom: 30px;
        }

        .offline-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, #059669, #34d399);
            color: #fff;
            padding: 4px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .setup-panel {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 28px;
            border: 1px solid var(--border);
        }

        .setup-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .setup-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .setup-label {
            text-align: left;
        }

        .setup-label h3 {
            font-size: 1rem;
            margin-bottom: 4px;
        }

        .setup-label p {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin: 0;
        }

        .setup-select {
            padding: 8px 16px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--surface);
            color: var(--text);
            font-size: 0.9rem;
            cursor: pointer;
        }

        .btn-play {
            background: linear-gradient(135deg, #7c3aed, #a855f7);
            color: white;
            font-size: 1.1rem;
            padding: 14px 40px;
            border-radius: 14px;
            font-weight: 700;
            width: 100%;
            margin-top: 24px;
            cursor: pointer;
            border: none;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn-play:hover {
            transform: scale(1.03);
            box-shadow: 0 8px 30px rgba(124, 58, 237, 0.4);
        }

        /* Offline game board */
        .off-board {
            display: none;
        }

        .off-board.active {
            display: block;
        }

        .off-opponents {
            display: flex;
            gap: 16px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .off-opp {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 12px 18px;
            border: 1px solid var(--border);
            text-align: center;
            min-width: 120px;
            position: relative;
            transition: border-color 0.3s;
        }

        .off-opp.active-turn {
            border-color: var(--primary);
            box-shadow: 0 0 16px rgba(99, 102, 241, 0.4);
        }

        .off-opp .opp-name {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .off-opp .opp-cards {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .off-center {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 30px;
            margin: 24px 0;
        }

        .off-draw {
            width: 80px;
            height: 120px;
            background: linear-gradient(135deg, #1e1b4b, #312e81);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 2px solid var(--border);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .off-draw:hover {
            transform: scale(1.06);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.3);
        }

        .off-draw .draw-label {
            color: #a5b4fc;
            font-size: 0.7rem;
            margin-top: 4px;
        }

        .off-draw .draw-text {
            font-weight: 900;
            font-size: 1.1rem;
            color: #e0e7ff;
        }

        .off-discard {
            width: 80px;
            height: 120px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 800;
            border: 3px solid var(--border);
            position: relative;
        }

        .off-discard .chosen-dot {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #fff;
        }

        .off-dir {
            font-size: 2rem;
            color: var(--text-muted);
        }

        .off-hand-area {
            margin-top: 20px;
        }

        .off-hand-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .off-turn-badge {
            background: var(--primary);
            color: #fff;
            padding: 4px 14px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.6;
            }
        }

        .off-hand {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            justify-content: center;
            padding: 10px;
            min-height: 100px;
        }

        .off-card {
            width: 60px;
            height: 90px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.2s, border-color 0.2s, box-shadow 0.2s;
            user-select: none;
            position: relative;
        }

        .off-card:hover {
            transform: translateY(-8px);
        }

        .off-card.playable {
            border-color: rgba(255, 255, 255, 0.6);
            box-shadow: 0 0 12px rgba(255, 255, 255, 0.2);
        }

        .off-card.selected {
            transform: translateY(-14px);
            border-color: #fff;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.4);
        }

        .off-card .card-num {
            font-size: 1.3rem;
        }

        .off-card .card-type {
            font-size: 0.6rem;
            text-align: center;
            line-height: 1.1;
        }

        .off-card.not-playable {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none !important;
        }

        .off-card.not-playable:hover {
            transform: none;
        }

        .card-red {
            background: linear-gradient(135deg, #dc2626, #ef4444);
            color: #fff;
        }

        .card-blue {
            background: linear-gradient(135deg, #2563eb, #3b82f6);
            color: #fff;
        }

        .card-green {
            background: linear-gradient(135deg, #16a34a, #22c55e);
            color: #fff;
        }

        .card-yellow {
            background: linear-gradient(135deg, #ca8a04, #eab308);
            color: #000;
        }

        .card-wild {
            background: linear-gradient(135deg, #7c3aed, #a855f7, #ec4899);
            color: #fff;
        }

        .off-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 14px;
            flex-wrap: wrap;
        }

        .off-actions .btn {
            font-size: 0.85rem;
            padding: 8px 18px;
        }

        /* Color picker */
        .off-color-picker {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }

        .off-color-picker.show {
            display: flex;
        }

        .off-color-picker-inner {
            display: flex;
            gap: 16px;
            background: var(--card-bg);
            padding: 30px;
            border-radius: 18px;
        }

        .off-color-picker-inner h3 {
            width: 100%;
            text-align: center;
            margin-bottom: 10px;
        }

        .color-pick {
            width: 60px;
            height: 60px;
            border-radius: 14px;
            border: 3px solid transparent;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .color-pick:hover {
            transform: scale(1.15);
        }

        .color-pick.cp-red {
            background: #ef4444;
        }

        .color-pick.cp-blue {
            background: #3b82f6;
        }

        .color-pick.cp-green {
            background: #22c55e;
        }

        .color-pick.cp-yellow {
            background: #eab308;
        }

        /* Event log */
        .off-log {
            max-height: 200px;
            overflow-y: auto;
            background: var(--surface);
            border-radius: 12px;
            padding: 12px;
            margin-top: 16px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .off-log p {
            margin: 3px 0;
            padding: 3px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .off-log p:last-child {
            border-bottom: none;
        }

        /* Game over */
        .off-gameover {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 200;
            align-items: center;
            justify-content: center;
        }

        .off-gameover.show {
            display: flex;
        }

        .off-gameover-inner {
            background: var(--card-bg);
            padding: 36px;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
        }

        .off-gameover-inner h2 {
            font-size: 1.8rem;
            margin-bottom: 12px;
        }

        .off-gameover-inner .scores {
            text-align: left;
            margin: 16px 0;
        }

        .off-gameover-inner .score-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid var(--border);
        }

        .off-uno-btn {
            background: linear-gradient(135deg, #dc2626, #f59e0b) !important;
            color: white !important;
            font-weight: 800 !important;
            animation: pulse 0.8s infinite;
        }

        /* Active color banner */
        .off-color-banner {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 12px;
            border: 2px solid transparent;
            font-size: 0.95rem;
            font-weight: 700;
            color: white;
            margin: 10px auto;
            max-width: 320px;
            text-align: center;
        }

        .off-color-banner.show {
            display: flex;
        }

        .off-color-banner .color-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid #fff;
            display: inline-block;
        }

        .off-hint {
            text-align: center;
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 8px;
            font-style: italic;
        }
    </style>
</head>

<body>

    <!-- Navigation -->
    <nav class="nav">
        <div class="nav-brand">
            <div class="logo-icon">üÇ°</div>
            UNO Arena
        </div>
        <ul class="nav-links">
            <li><a href="/">üéÆ Lobby</a></li>
            <li><a href="/offline.html" class="active">ü§ñ Offline</a></li>
            <li><a href="/rules.html">üìñ Rules</a></li>
            <li><a href="/leaderboard.html">üèÜ Leaderboard</a></li>
            <li><a href="/shop.html">üõí Shop</a></li>
        </ul>
    </nav>

    <!-- Setup Screen -->
    <div class="page-container" id="setup-screen">
        <div class="offline-setup">
            <div class="offline-badge">üì° No Internet Required</div>
            <h1>ü§ñ Offline Play</h1>
            <p class="subtitle">Play UNO against AI bots ‚Äî works without internet!</p>

            <div class="setup-panel">
                <div class="setup-row">
                    <div class="setup-label">
                        <h3>üéØ Difficulty</h3>
                        <p>How smart should the bots be?</p>
                    </div>
                    <select class="setup-select" id="diff-select">
                        <option value="easy">üü¢ Easy</option>
                        <option value="medium" selected>üü° Medium</option>
                        <option value="hard">üî¥ Hard</option>
                    </select>
                </div>
                <div class="setup-row">
                    <div class="setup-label">
                        <h3>üë• Number of Bots</h3>
                        <p>1-3 AI opponents</p>
                    </div>
                    <select class="setup-select" id="bot-count-select">
                        <option value="1" selected>1 Bot</option>
                        <option value="2">2 Bots</option>
                        <option value="3">3 Bots</option>
                    </select>
                </div>
            </div>

            <button class="btn-play" onclick="startOfflineGame()">üöÄ Start Game</button>
            <p style="margin-top:14px;font-size:0.8rem;color:var(--text-muted)">Using official UNO rules ¬∑ <a
                    href="/rules.html" style="color:var(--primary)">View full rules ‚Üí</a></p>
        </div>
    </div>

    <!-- Game Board -->
    <div class="page-container off-board" id="game-board">
        <div style="max-width:800px;margin:0 auto">
            <!-- Opponents -->
            <div class="off-opponents" id="off-opponents"></div>

            <!-- Center -->
            <div class="off-center">
                <div>
                    <div class="off-draw" id="off-draw" onclick="offlineDraw()">
                        <span class="draw-text">UNO</span>
                        <span class="draw-label" id="off-deck-count">0</span>
                    </div>
                    <div style="text-align:center;font-size:0.7rem;color:var(--text-muted);margin-top:4px">Draw</div>
                </div>
                <div class="off-dir" id="off-direction">‚Üª</div>
                <div>
                    <div class="off-discard" id="off-discard"></div>
                    <div style="text-align:center;font-size:0.7rem;color:var(--text-muted);margin-top:4px">Discard</div>
                </div>
            </div>

            <!-- Active Color Banner -->
            <div class="off-color-banner" id="off-color-banner"></div>

            <!-- Player Hand -->
            <div class="off-hand-area">
                <div class="off-hand-label">
                    <span style="font-weight:600">üÉè Your Hand</span>
                    <span id="off-turn-indicator"></span>
                </div>
                <div class="off-hand" id="off-hand"></div>
                <div class="off-actions">
                    <button class="btn btn-primary hidden" id="off-play-btn" onclick="offlinePlaySelected()">‚ñ∂ Play
                        Card</button>
                    <button class="btn off-uno-btn hidden" id="off-uno-btn" onclick="offlineCallUno()">UNO!</button>
                </div>
            </div>

            <!-- Event Log -->
            <div class="off-log" id="off-log"></div>
        </div>
    </div>

    <!-- Color Picker -->
    <div class="off-color-picker" id="off-color-picker">
        <div
            style="display:flex;flex-direction:column;align-items:center;background:var(--card-bg);padding:30px;border-radius:18px">
            <h3 style="margin-bottom:16px">Choose a Color</h3>
            <div style="display:flex;gap:16px">
                <button class="color-pick cp-red" onclick="offlinePickColor('red')"></button>
                <button class="color-pick cp-blue" onclick="offlinePickColor('blue')"></button>
                <button class="color-pick cp-green" onclick="offlinePickColor('green')"></button>
                <button class="color-pick cp-yellow" onclick="offlinePickColor('yellow')"></button>
            </div>
        </div>
    </div>

    <!-- Game Over -->
    <div class="off-gameover" id="off-gameover">
        <div class="off-gameover-inner">
            <h2 id="off-go-title">üéâ Game Over!</h2>
            <div id="off-go-content"></div>
            <div style="display:flex;gap:10px;margin-top:20px;justify-content:center">
                <button class="btn btn-primary" onclick="startOfflineGame()">üîÑ Play Again</button>
                <button class="btn btn-secondary" onclick="backToSetup()">üè† Setup</button>
            </div>
        </div>
    </div>

    <script src="/js/offline-engine.js"></script>
    <script>
        let offGame = null;
        let selectedCardId = null;
        let pendingWildCardId = null;

        function startOfflineGame() {
            const diff = document.getElementById('diff-select').value;
            const botCount = parseInt(document.getElementById('bot-count-select').value);
            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('game-board').classList.add('active');
            document.getElementById('off-gameover').classList.remove('show');
            selectedCardId = null;
            pendingWildCardId = null;

            offGame = new OfflineEngine.OfflineGame(botCount, diff);
            offGame.onUpdate = renderOfflineState;
            offGame.onBotPlay = (bot, move, result) => { /* already handled by onUpdate */ };
            offGame.onGameOver = showOfflineGameOver;
            offGame.start();
        }

        function backToSetup() {
            document.getElementById('setup-screen').style.display = '';
            document.getElementById('game-board').classList.remove('active');
            document.getElementById('off-gameover').classList.remove('show');
        }

        function renderOfflineState(state) {
            // Opponents
            const oppContainer = document.getElementById('off-opponents');
            oppContainer.innerHTML = state.playerCardCounts
                .filter(p => p.id !== 'player_1')
                .map(p => `
          <div class="off-opp ${state.currentPlayer.id === p.id ? 'active-turn' : ''}">
            <div class="opp-name">${p.username}</div>
            <div class="opp-cards">üÉè ${p.cardCount} card${p.cardCount !== 1 ? 's' : ''}</div>
          </div>
        `).join('');

            // Direction
            document.getElementById('off-direction').textContent = state.direction === 1 ? '‚Üª' : '‚Ü∫';

            // Deck count
            document.getElementById('off-deck-count').textContent = state.deckRemaining + ' cards';

            // Discard pile
            const discardEl = document.getElementById('off-discard');
            const top = state.topCard;
            if (top) {
                // Show discarded card with the ACTIVE color if wild  
                const activeColor = state.chosenColor || top.color;
                const colorClass = activeColor ? `card-${activeColor}` : 'card-wild';
                let label = '';
                if (top.type === 'number') label = `<span class="card-num">${top.value}</span>`;
                else {
                    const icons = { skip: '‚õî', reverse: 'üîÑ', draw_two: '+2', wild: 'üåà', wild_draw_four: '+4' };
                    label = `<span class="card-type">${icons[top.type] || top.type}</span>`;
                }
                discardEl.className = `off-discard ${colorClass}`;
                discardEl.innerHTML = label;
            }

            // Active color banner (always shows current color)
            const activeColor = state.chosenColor || (state.topCard ? state.topCard.color : null);
            const banner = document.getElementById('off-color-banner');
            if (activeColor) {
                const colorNames = { red: 'üî¥ RED', blue: 'üîµ BLUE', green: 'üü¢ GREEN', yellow: 'üü° YELLOW' };
                const colorHex = { red: '#ef4444', blue: '#3b82f6', green: '#22c55e', yellow: '#eab308' };
                banner.innerHTML = `<span class="color-dot" style="background:${colorHex[activeColor]}"></span> Current Color: <strong>${colorNames[activeColor]}</strong>`;
                banner.style.background = `${colorHex[activeColor]}25`;
                banner.style.borderColor = `${colorHex[activeColor]}66`;
                banner.classList.add('show');
            } else {
                banner.classList.remove('show');
            }

            // Player hand
            const hand = offGame.getPlayerHand();
            const isMyTurn = state.currentPlayer.id === 'player_1';
            const handContainer = document.getElementById('off-hand');

            let anyPlayable = false;
            handContainer.innerHTML = hand.map(card => {
                const cardColorClass = card.color ? `card-${card.color}` : 'card-wild';
                const playable = isMyTurn && OfflineEngine.canPlayCard(card, state.topCard, state.chosenColor, hand);
                if (playable) anyPlayable = true;

                // Determine card state classes
                let stateClass = '';
                if (isMyTurn && playable) stateClass = 'playable';
                else if (isMyTurn && !playable) stateClass = 'not-playable';

                let label = '';
                if (card.type === 'number') label = `<span class="card-num">${card.value}</span>`;
                else {
                    const icons = { skip: '‚õî', reverse: 'üîÑ', draw_two: '+2', wild: 'üåà', wild_draw_four: '+4' };
                    label = `<span class="card-type">${icons[card.type] || card.type}</span>`;
                }
                return `<div class="off-card ${cardColorClass} ${stateClass} ${selectedCardId === card.id ? 'selected' : ''}"
                     data-card-id="${card.id}" onclick="selectOfflineCard('${card.id}')">${label}</div>`;
            }).join('');

            // Draw hint when no cards are playable
            let hintEl = document.getElementById('off-hint');
            if (!hintEl) {
                hintEl = document.createElement('div');
                hintEl.id = 'off-hint';
                hintEl.className = 'off-hint';
                handContainer.after(hintEl);
            }
            if (isMyTurn && !anyPlayable) {
                hintEl.textContent = '‚òùÔ∏è No playable cards ‚Äî click the Draw pile to draw a card!';
                hintEl.style.display = '';
            } else {
                hintEl.style.display = 'none';
            }

            // Turn indicator
            const turnEl = document.getElementById('off-turn-indicator');
            if (isMyTurn) {
                turnEl.innerHTML = '<span class="off-turn-badge">YOUR TURN</span>';
            } else {
                turnEl.innerHTML = `<span style="font-size:0.8rem;color:var(--text-muted)">${state.currentPlayer.username}'s turn...</span>`;
            }

            // Play button
            const playBtn = document.getElementById('off-play-btn');
            if (selectedCardId && isMyTurn) {
                playBtn.classList.remove('hidden');
            } else {
                playBtn.classList.add('hidden');
            }

            // UNO button
            const unoBtn = document.getElementById('off-uno-btn');
            if (isMyTurn && hand.length <= 2) {
                unoBtn.classList.remove('hidden');
            } else {
                unoBtn.classList.add('hidden');
            }

            // Event log
            const logEl = document.getElementById('off-log');
            logEl.innerHTML = state.eventLog.map(e => `<p>${e.text}</p>`).join('');
            logEl.scrollTop = logEl.scrollHeight;
        }

        function selectOfflineCard(cardId) {
            if (!offGame) return;
            const state = offGame.getState();
            const isMyTurn = state.currentPlayer.id === 'player_1';
            if (!isMyTurn) return;

            const hand = offGame.getPlayerHand();
            const card = hand.find(c => c.id === cardId);
            if (!card) return;

            // Don't allow selecting unplayable cards
            if (!OfflineEngine.canPlayCard(card, state.topCard, state.chosenColor, hand)) return;

            if (selectedCardId === cardId) {
                selectedCardId = null;
            } else {
                selectedCardId = cardId;
            }
            renderOfflineState(state);
        }

        function offlinePlaySelected() {
            if (!offGame || !selectedCardId) return;
            const hand = offGame.getPlayerHand();
            const card = hand.find(c => c.id === selectedCardId);
            if (!card) return;

            // Check if it's a wild card ‚Äî need color picker
            if (card.type === 'wild' || card.type === 'wild_draw_four') {
                pendingWildCardId = selectedCardId;
                document.getElementById('off-color-picker').classList.add('show');
                return;
            }

            const result = offGame.playCard('player_1', selectedCardId, null);
            if (!result.success) {
                alert(result.error);
            }
            selectedCardId = null;
        }

        function offlinePickColor(color) {
            document.getElementById('off-color-picker').classList.remove('show');
            if (!offGame || !pendingWildCardId) return;

            const result = offGame.playCard('player_1', pendingWildCardId, color);
            if (!result.success) {
                alert(result.error);
            }
            pendingWildCardId = null;
            selectedCardId = null;
        }

        function offlineDraw() {
            if (!offGame) return;
            const state = offGame.getState();
            if (state.currentPlayer.id !== 'player_1') return;

            const result = offGame.drawCard('player_1');
            if (!result.success) {
                alert(result.error);
            }
            selectedCardId = null;
        }

        function offlineCallUno() {
            if (!offGame) return;
            offGame.callUno('player_1');
        }

        function showOfflineGameOver(winnerId, scores) {
            const state = offGame.getState();
            const winner = state.players.find(p => p.id === winnerId);
            const isPlayerWin = winnerId === 'player_1';

            document.getElementById('off-go-title').textContent = isPlayerWin ? 'üèÜ You Win!' : `üíÄ ${winner.username} Wins!`;

            let html = '<div class="scores">';
            for (const p of state.players) {
                const s = scores[p.id] || 0;
                html += `<div class="score-row"><span>${p.id === winnerId ? 'üëë ' : ''}${p.username}</span><span>${s} pts</span></div>`;
            }
            html += '</div>';
            document.getElementById('off-go-content').innerHTML = html;
            document.getElementById('off-gameover').classList.add('show');
        }
    </script>
</body>

</html>