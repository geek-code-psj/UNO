<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description"
        content="UNO Arena Tournaments â€” Create and join single-elimination tournaments for prizes.">
    <title>Tournaments â€” UNO Arena</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>

<body>

    <nav class="nav">
        <a class="nav-brand" href="/">
            <div class="logo-icon">ğŸ‚¡</div>
            UNO Arena
        </a>
        <ul class="nav-links">
            <li><a href="/">ğŸ® Lobby</a></li>
            <li><a href="/offline.html">ğŸ¤– Offline</a></li>
            <li><a href="/rules.html">ğŸ“– Rules</a></li>
            <li><a href="/leaderboard.html">ğŸ† Leaderboard</a></li>
            <li><a href="/shop.html">ğŸ›’ Shop</a></li>
            <li><a href="/tournament.html" class="active">âš”ï¸ Tournaments</a></li>
        </ul>
        <div class="nav-user">
            <div class="coins"><span>ğŸª™</span> <span id="coin-count">0</span></div>
        </div>
    </nav>

    <div class="toast-container" id="toast-container"></div>

    <div class="page-container">
        <div class="page-header" style="display:flex;justify-content:space-between;align-items:flex-start">
            <div>
                <h1>âš”ï¸ Tournaments</h1>
                <p>Compete in single-elimination brackets for prizes</p>
            </div>
            <button class="btn btn-primary" onclick="showCreateModal()">âœ¨ Create Tournament</button>
        </div>

        <div class="tabs">
            <button class="tab-btn active" onclick="loadTournaments(null, this)">All</button>
            <button class="tab-btn" onclick="loadTournaments('registration', this)">ğŸ“ Open</button>
            <button class="tab-btn" onclick="loadTournaments('active', this)">ğŸ”´ Active</button>
            <button class="tab-btn" onclick="loadTournaments('completed', this)">âœ… Completed</button>
        </div>

        <div class="grid-2" id="tournament-list">
            <div style="text-align:center;padding:40px;color:var(--text-muted);grid-column:1/-1">Loading tournaments...
            </div>
        </div>

        <!-- Tournament Detail View -->
        <div class="hidden" id="tournament-detail">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:20px">
                <button class="btn btn-secondary btn-sm" onclick="hideTournamentDetail()">â† Back</button>
                <h2 id="detail-name"></h2>
                <span id="detail-status" class="item-rarity" style="padding:4px 12px"></span>
            </div>

            <div class="grid-2" style="margin-bottom:24px">
                <div class="panel">
                    <h3 style="margin-bottom:12px">ğŸ“‹ Info</h3>
                    <div id="detail-info"></div>
                </div>
                <div class="panel">
                    <h3 style="margin-bottom:12px">ğŸ‘¥ Players</h3>
                    <div id="detail-players"></div>
                </div>
            </div>

            <div class="panel">
                <h3 style="margin-bottom:16px">ğŸ† Bracket</h3>
                <div class="bracket-container" id="bracket-container">
                    <div style="text-align:center;padding:40px;color:var(--text-muted);width:100%">
                        Bracket not generated yet
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Tournament Modal -->
    <div class="modal-overlay hidden" id="create-modal">
        <div class="modal">
            <h2>Create Tournament</h2>
            <div class="form-group input-group">
                <label>Tournament Name</label>
                <input type="text" id="t-name" placeholder="Weekend Showdown">
            </div>
            <div class="form-group input-group" style="margin-top:12px">
                <label>Max Players</label>
                <select id="t-max-players">
                    <option value="4">4 Players</option>
                    <option value="8" selected>8 Players</option>
                    <option value="16">16 Players</option>
                </select>
            </div>
            <div class="form-group input-group" style="margin-top:12px">
                <label>Entry Fee (coins, 0 = free)</label>
                <input type="number" id="t-fee" value="0" min="0">
            </div>
            <div style="display:flex;gap:10px;margin-top:20px">
                <button class="btn btn-primary" style="flex:1" onclick="createTournament()">Create</button>
                <button class="btn btn-secondary" style="flex:1" onclick="hideCreateModal()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('uno_token');

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const icons = { success: 'âœ…', error: 'âŒ', info: 'â„¹ï¸' };
            toast.innerHTML = `<span>${icons[type]}</span> ${message}`;
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3500);
        }

        async function apiFetch(url, opts = {}) {
            const headers = { 'Content-Type': 'application/json', ...opts.headers };
            if (token) headers['Authorization'] = `Bearer ${token}`;
            const res = await fetch(url, { ...opts, headers });
            const data = await res.json();
            if (!res.ok) throw new Error(data.error || 'Request failed');
            return data;
        }

        function showCreateModal() {
            if (!token) return showToast('Login to create tournaments', 'error');
            document.getElementById('create-modal').classList.remove('hidden');
        }

        function hideCreateModal() {
            document.getElementById('create-modal').classList.add('hidden');
        }

        async function createTournament() {
            try {
                const name = document.getElementById('t-name').value.trim();
                const maxPlayers = parseInt(document.getElementById('t-max-players').value);
                const entryFee = parseInt(document.getElementById('t-fee').value) || 0;
                if (!name) return showToast('Enter a name', 'error');

                await apiFetch('/api/tournament/create', {
                    method: 'POST',
                    body: JSON.stringify({ name, maxPlayers, entryFee }),
                });
                showToast('Tournament created! ğŸ‰', 'success');
                hideCreateModal();
                loadTournaments();
            } catch (err) {
                showToast(err.message, 'error');
            }
        }

        async function loadTournaments(status = null, btn) {
            if (btn) {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }

            try {
                const url = status ? `/api/tournament/list?status=${status}` : '/api/tournament/list';
                const data = await apiFetch(url);
                renderTournamentList(data.tournaments || []);
            } catch (err) {
                console.error('Tournament load error:', err);
            }
        }

        function renderTournamentList(tournaments) {
            const container = document.getElementById('tournament-list');

            if (tournaments.length === 0) {
                container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted);grid-column:1/-1">No tournaments found. Create one!</div>';
                return;
            }

            const statusColors = {
                registration: 'common',
                active: 'rare',
                completed: 'epic',
                cancelled: 'common',
            };

            container.innerHTML = tournaments.map(t => `
        <div class="panel" style="cursor:pointer" onclick="viewTournament('${t.id}')">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <h3>${t.name}</h3>
            <span class="item-rarity ${statusColors[t.status]}" style="padding:2px 10px">${t.status}</span>
          </div>
          <div style="display:flex;gap:16px;font-size:0.85rem;color:var(--text-secondary)">
            <span>ğŸ‘¥ ${t.max_players} players</span>
            <span>ğŸª™ Entry: ${t.entry_fee || 'Free'}</span>
            <span>ğŸ’° Prize: ${t.prize_pool || 0}</span>
          </div>
        </div>
      `).join('');
        }

        async function viewTournament(id) {
            try {
                const data = await apiFetch(`/api/tournament/${id}`);
                document.getElementById('tournament-list').classList.add('hidden');
                document.querySelector('.tabs').classList.add('hidden');
                const detail = document.getElementById('tournament-detail');
                detail.classList.remove('hidden');

                document.getElementById('detail-name').textContent = data.tournament.name;
                const statusEl = document.getElementById('detail-status');
                statusEl.textContent = data.tournament.status;
                statusEl.className = 'item-rarity ' + ({ registration: 'common', active: 'rare', completed: 'epic' }[data.tournament.status] || '');

                // Info
                document.getElementById('detail-info').innerHTML = `
          <p style="margin-bottom:8px"><strong>Max Players:</strong> ${data.tournament.max_players}</p>
          <p style="margin-bottom:8px"><strong>Entry Fee:</strong> ${data.tournament.entry_fee || 'Free'} ğŸª™</p>
          <p style="margin-bottom:8px"><strong>Prize Pool:</strong> ${data.tournament.prize_pool} ğŸª™</p>
          <p style="margin-bottom:16px"><strong>Status:</strong> ${data.tournament.status}</p>
          ${data.tournament.status === 'registration' ? `
            <button class="btn btn-primary btn-sm" onclick="joinTournament('${id}')">Join Tournament</button>
            <button class="btn btn-success btn-sm" style="margin-left:8px" onclick="startTournament('${id}')">Start Bracket</button>
          ` : ''}
        `;

                // Players
                document.getElementById('detail-players').innerHTML = data.players.length > 0
                    ? data.players.map((p, i) => `
            <div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border-glass)">
              <span style="color:var(--text-muted);width:20px">#${i + 1}</span>
              <span style="font-weight:600">${p.username}</span>
              ${p.eliminated ? '<span style="color:var(--danger);font-size:0.8rem">Eliminated</span>' : ''}
            </div>
          `).join('')
                    : '<p style="color:var(--text-muted)">No players registered yet</p>';

                // Bracket
                renderBracket(data.bracket || []);
            } catch (err) {
                showToast(err.message, 'error');
            }
        }

        function renderBracket(bracket) {
            const container = document.getElementById('bracket-container');
            if (!bracket || bracket.length === 0) {
                container.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted);width:100%">Bracket not generated yet. Waiting for tournament to start.</div>';
                return;
            }

            const roundNames = ['Round 1', 'Quarter-Finals', 'Semi-Finals', 'Finals'];

            container.innerHTML = bracket.map((round, ri) => {
                const roundName = bracket.length - ri <= 4
                    ? roundNames[4 - (bracket.length - ri)]
                    : `Round ${ri + 1}`;

                return `
          <div class="bracket-round">
            <div class="bracket-round-title">${roundName}</div>
            ${round.map(match => `
              <div class="bracket-match">
                <div class="bracket-player ${match.winner === match.player1?.id ? 'winner' : ''} ${!match.player1 ? 'bye' : ''}">
                  <span>${match.player1?.username || 'TBD'}</span>
                  ${match.winner === match.player1?.id ? '<span>âœ“</span>' : ''}
                </div>
                <div class="bracket-player ${match.winner === match.player2?.id ? 'winner' : ''} ${!match.player2 ? 'bye' : ''}">
                  <span>${match.player2?.username || (match.status === 'bye' ? 'BYE' : 'TBD')}</span>
                  ${match.winner === match.player2?.id ? '<span>âœ“</span>' : ''}
                </div>
              </div>
            `).join('')}
          </div>
        `;
            }).join('');
        }

        function hideTournamentDetail() {
            document.getElementById('tournament-detail').classList.add('hidden');
            document.getElementById('tournament-list').classList.remove('hidden');
            document.querySelector('.tabs').classList.remove('hidden');
        }

        async function joinTournament(id) {
            if (!token) return showToast('Login to join', 'error');
            try {
                await apiFetch(`/api/tournament/join/${id}`, { method: 'POST' });
                showToast('Joined tournament! ğŸ‰', 'success');
                viewTournament(id);
            } catch (err) {
                showToast(err.message, 'error');
            }
        }

        async function startTournament(id) {
            if (!token) return showToast('Login required', 'error');
            try {
                await apiFetch(`/api/tournament/${id}/start`, { method: 'POST' });
                showToast('Tournament started! Bracket generated ğŸ†', 'success');
                viewTournament(id);
            } catch (err) {
                showToast(err.message, 'error');
            }
        }

        // Init
        if (token) {
            apiFetch('/api/auth/profile')
                .then(d => { if (d.user) document.getElementById('coin-count').textContent = d.user.coins; })
                .catch(() => { });
        }
        loadTournaments();
    </script>
</body>

</html>